<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>诗句消消乐</title>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Marker Felt', '微软雅黑', sans-serif;
            background-color: #e3f2fd;
            margin: 0;
            padding: 20px;
            text-align: center;
            color: #2c3e50;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border: 5px dashed #90caf9;
        }
        
        h1 {
            color: #1976d2;
            text-shadow: 2px 2px 0px #bbdefb;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #5c6bc0;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px auto;
            max-width: 500px;
        }
        
        .card {
            height: 80px;
            background-color: #bbdefb;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            position: relative;
            perspective: 1000px;
            transform-style: preserve-3d;
        }
        
        .card.flipped {
            transform: rotateY(180deg);
            background-color: #e3f2fd;
        }
        
        .card.matched {
            background-color: #a5d6a7;
            cursor: default;
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
        }
        
        .card-front {
            background-color: #bbdefb;
            transform: rotateY(0deg);
        }
        
        .card-back {
            background-color: #e3f2fd;
            transform: rotateY(180deg);
        }
        
        .game-info {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .info-box {
            background-color: #e3f2fd;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        button {
            background-color: #42a5f5;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            font-family: 'Comic Sans MS', 'Marker Felt', '微软雅黑', sans-serif;
        }
        
        button:hover {
            background-color: #1e88e5;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .settings {
            margin-top: 30px;
            padding: 20px;
            background-color: #e3f2fd;
            border-radius: 10px;
            border: 3px dotted #90caf9;
            text-align: left;
        }
        
        .settings-title {
            font-size: 20px;
            color: #1976d2;
            margin-bottom: 15px;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #90caf9;
            font-family: 'Comic Sans MS', 'Marker Felt', '微软雅黑', sans-serif;
            font-size: 16px;
            margin-bottom: 10px;
            resize: vertical;
        }
        
        .player-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input {
            padding: 10px 15px;
            border-radius: 50px;
            border: 2px solid #90caf9;
            font-family: 'Comic Sans MS', 'Marker Felt', '微软雅黑', sans-serif;
            font-size: 16px;
            outline: none;
        }
        
        input:focus {
            border-color: #42a5f5;
        }
        
        .leaderboard {
            margin-top: 30px;
            padding: 20px;
            background-color: #e3f2fd;
            border-radius: 10px;
            border: 3px dotted #90caf9;
        }
        
        .leaderboard-title {
            font-size: 20px;
            color: #1976d2;
            margin-bottom: 15px;
            text-align: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #bbdefb;
        }
        
        th {
            background-color: #bbdefb;
            color: #0d47a1;
        }
        
        tr:nth-child(even) {
            background-color: #e1f5fe;
        }
        
        tr:hover {
            background-color: #b3e5fc;
        }
        
        .export-btn {
            margin-top: 15px;
            background-color: #5c6bc0;
        }
        
        .export-btn:hover {
            background-color: #3949ab;
        }
        
        .poem-preview {
            margin-top: 20px;
            padding: 15px;
            background-color: #e1f5fe;
            border-radius: 10px;
            font-size: 18px;
            line-height: 1.6;
        }
        
        @media (max-width: 600px) {
            .game-board {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .card {
                height: 70px;
                font-size: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .player-input {
                flex-direction: column;
            }
        }
        
        /* 动画效果 */
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(180deg); }
        }
        
        @keyframes match {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .matched {
            animation: match 0.5s;
        }
        
        .flipped {
            animation: flip 0.5s forwards;
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(500px) rotate(360deg); opacity: 0; }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0;
            z-index: 10;
            animation: confetti 2s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📜 诗句消消乐 📜</h1>
        <div class="subtitle">匹配诗句上下联，挑战最快时间！</div>
        
        <div class="game-area">
            <div class="player-input">
                <input type="text" id="playerName" placeholder="输入你的名字" required>
                <button id="startBtn">开始游戏</button>
            </div>
            
            <div class="game-info">
                <div class="info-box">时间: <span id="timer">00:00</span></div>
                <div class="info-box">匹配: <span id="matches">0</span> / <span id="totalPairs">0</span></div>
                <div class="info-box">尝试: <span id="attempts">0</span></div>
            </div>
            
            <div class="game-board" id="gameBoard">
                <!-- 游戏卡片将通过JavaScript动态生成 -->
            </div>
            
            <div class="poem-preview" id="poemPreview">
                游戏开始后会显示诗句预览
            </div>
            
            <div class="controls">
                <button id="newGameBtn" disabled>新游戏</button>
                <button id="settingsBtn">诗句设置</button>
                <button id="leaderboardBtn">排行榜</button>
            </div>
        </div>
        
        <div class="settings" id="settingsPanel" style="display: none;">
            <div class="settings-title">🖋️ 诗句设置</div>
            <p>每行输入一句诗，上下联诗句会自动配对：</p>
            <textarea id="poemsInput" placeholder="例如：
床前明月光
疑是地上霜
春眠不觉晓
处处闻啼鸟"></textarea>
            <button id="savePoemsBtn">保存诗句</button>
            <button id="defaultPoemsBtn">恢复默认诗句</button>
        </div>
        
        <div class="leaderboard" id="leaderboardPanel" style="display: none;">
            <div class="leaderboard-title">🏆 排行榜</div>
            <table id="leaderboardTable">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>姓名</th>
                        <th>时间</th>
                        <th>日期</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <!-- 排行榜将通过JavaScript动态生成 -->
                </tbody>
            </table>
            <button class="export-btn" id="exportLeaderboardBtn">导出排行榜</button>
        </div>
    </div>

    <audio id="flipSound" src="https://www.soundjay.com/mechanical/sounds/card-flip-01.mp3" preload="auto"></audio>
    <audio id="matchSound" src="https://www.soundjay.com/buttons/sounds/button-09.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://www.soundjay.com/human/sounds/applause-8.mp3" preload="auto"></audio>

    <script>
        // 默认诗句数据
        const defaultPoems = [
            "床前明月光", "疑是地上霜",
            "春眠不觉晓", "处处闻啼鸟",
            "白日依山尽", "黄河入海流",
            "红豆生南国", "春来发几枝",
            "锄禾日当午", "汗滴禾下土",
            "离离原上草", "一岁一枯荣",
            "空山不见人", "但闻人语响",
            "千山鸟飞绝", "万径人踪灭",
            "慈母手中线", "游子身上衣",
            "国破山河在", "城春草木深"
        ];
        
        // 游戏状态
        let poems = JSON.parse(localStorage.getItem('poemMemoryGamePoems')) || [...defaultPoems];
        let leaderboard = JSON.parse(localStorage.getItem('poemMemoryGameLeaderboard')) || [];
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let attempts = 0;
        let timer = null;
        let seconds = 0;
        let gameStarted = false;
        let currentPlayer = '';
        
        // DOM元素
        const gameBoard = document.getElementById('gameBoard');
        const timerDisplay = document.getElementById('timer');
        const matchesDisplay = document.getElementById('matches');
        const totalPairsDisplay = document.getElementById('totalPairs');
        const attemptsDisplay = document.getElementById('attempts');
        const playerNameInput = document.getElementById('playerName');
        const startBtn = document.getElementById('startBtn');
        const newGameBtn = document.getElementById('newGameBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const leaderboardBtn = document.getElementById('leaderboardBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const leaderboardPanel = document.getElementById('leaderboardPanel');
        const poemsInput = document.getElementById('poemsInput');
        const savePoemsBtn = document.getElementById('savePoemsBtn');
        const defaultPoemsBtn = document.getElementById('defaultPoemsBtn');
        const leaderboardBody = document.getElementById('leaderboardBody');
        const exportLeaderboardBtn = document.getElementById('exportLeaderboardBtn');
        const poemPreview = document.getElementById('poemPreview');
        const flipSound = document.getElementById('flipSound');
        const matchSound = document.getElementById('matchSound');
        const winSound = document.getElementById('winSound');
        
        // 初始化
        function init() {
            renderPoemPreview();
            renderLeaderboard();
            
            // 事件监听
            startBtn.addEventListener('click', startGame);
            newGameBtn.addEventListener('click', setupGame);
            settingsBtn.addEventListener('click', toggleSettings);
            leaderboardBtn.addEventListener('click', toggleLeaderboard);
            savePoemsBtn.addEventListener('click', savePoems);
            defaultPoemsBtn.addEventListener('click', restoreDefaultPoems);
            exportLeaderboardBtn.addEventListener('click', exportLeaderboard);
            
            // 初始化诗句输入框
            poemsInput.value = poems.join('\n');
        }
        
        // 渲染诗句预览
        function renderPoemPreview() {
            let previewHTML = '';
            
            // 将诗句分成上下联
            for (let i = 0; i < poems.length; i += 2) {
                if (i + 1 < poems.length) {
                    previewHTML += `<div>${poems[i]} —— ${poems[i+1]}</div>`;
                } else {
                    previewHTML += `<div>${poems[i]}</div>`;
                }
            }
            
            poemPreview.innerHTML = previewHTML || '暂无诗句，请先设置诗句';
        }
        
        // 开始游戏
        function startGame() {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                alert('请输入你的名字！');
                return;
            }
            
            currentPlayer = playerName;
            playerNameInput.disabled = true;
            startBtn.disabled = true;
            
            setupGame();
        }
        
        // 设置游戏
        function setupGame() {
            // 重置游戏状态
            clearInterval(timer);
            seconds = 0;
            matchedPairs = 0;
            attempts = 0;
            flippedCards = [];
            gameStarted = false;
            
            // 更新UI
            updateTimer();
            matchesDisplay.textContent = matchedPairs;
            attemptsDisplay.textContent = attempts;
            
            // 创建卡片
            createCards();
            
            // 启用新游戏按钮
            newGameBtn.disabled = false;
        }
        
        // 创建卡片
        function createCards() {
            gameBoard.innerHTML = '';
            cards = [];
            
            // 确保诗句数量是偶数
            const usablePoems = [...poems];
            if (usablePoems.length % 2 !== 0) {
                usablePoems.pop(); // 如果是奇数，去掉最后一个
            }
            
            // 随机选择8对诗句(16张卡片)
            const selectedPoems = [];
            while (selectedPoems.length < 16 && usablePoems.length > 0) {
                const randomIndex = Math.floor(Math.random() * usablePoems.length);
                const poem = usablePoems.splice(randomIndex, 1)[0];
                selectedPoems.push(poem);
                
                // 如果是偶数索引，添加下联
                if (randomIndex % 2 === 0 && randomIndex + 1 < usablePoems.length) {
                    selectedPoems.push(usablePoems[randomIndex]);
                    usablePoems.splice(randomIndex, 1);
                }
            }
            
            // 如果诗句不够，随机复制一些
            while (selectedPoems.length < 16) {
                const randomPoem = poems[Math.floor(Math.random() * poems.length)];
                selectedPoems.push(randomPoem);
                selectedPoems.push(randomPoem);
            }
            
            // 打乱顺序
            shuffleArray(selectedPoems);
            
            // 创建卡片
            selectedPoems.forEach((poem, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.index = index;
                card.dataset.poem = poem;
                
                const cardFront = document.createElement('div');
                cardFront.className = 'card-face card-front';
                cardFront.textContent = '❓';
                
                const cardBack = document.createElement('div');
                cardBack.className = 'card-face card-back';
                cardBack.textContent = poem;
                
                card.appendChild(cardFront);
                card.appendChild(cardBack);
                
                card.addEventListener('click', () => flipCard(card));
                gameBoard.appendChild(card);
                
                cards.push({
                    element: card,
                    poem: poem,
                    matched: false
                });
            });
            
            // 更新总对数显示
            totalPairsDisplay.textContent = selectedPoems.length / 2;
        }
        
        // 翻转卡片
        function flipCard(card) {
            // 如果游戏未开始，开始计时
            if (!gameStarted) {
                startTimer();
                gameStarted = true;
            }
            
            const index = parseInt(card.dataset.index);
            const cardObj = cards[index];
            
            // 如果卡片已匹配或已翻转，忽略
            if (cardObj.matched || flippedCards.includes(index) || flippedCards.length >= 2) {
                return;
            }
            
            // 播放翻转音效
            flipSound.currentTime = 0;
            flipSound.play();
            
            // 翻转卡片
            card.classList.add('flipped');
            flippedCards.push(index);
            
            // 如果翻转了两张卡片，检查是否匹配
            if (flippedCards.length === 2) {
                attempts++;
                attemptsDisplay.textContent = attempts;
                
                const card1 = cards[flippedCards[0]];
                const card2 = cards[flippedCards[1]];
                
                // 检查是否是上下联
                const poem1 = card1.poem;
                const poem2 = card2.poem;
                let isPair = false;
                
                // 检查是否是默认配对
                for (let i = 0; i < poems.length; i += 2) {
                    if ((poem1 === poems[i] && poem2 === poems[i+1]) || 
                        (poem1 === poems[i+1] && poem2 === poems[i])) {
                        isPair = true;
                        break;
                    }
                }
                
                // 如果不是默认配对，检查是否相同
                if (!isPair && poem1 === poem2) {
                    isPair = true;
                }
                
                if (isPair) {
                    // 匹配成功
                    setTimeout(() => {
                        card1.element.classList.add('matched');
                        card2.element.classList.add('matched');
                        card1.matched = true;
                        card2.matched = true;
                        
                        // 播放匹配音效
                        matchSound.play();
                        
                        matchedPairs++;
                        matchesDisplay.textContent = matchedPairs;
                        
                        // 检查游戏是否结束
                        if (matchedPairs === parseInt(totalPairsDisplay.textContent)) {
                            endGame();
                        }
                        
                        flippedCards = [];
                    }, 500);
                } else {
                    // 不匹配，翻回去
                    setTimeout(() => {
                        cards[flippedCards[0]].element.classList.remove('flipped');
                        cards[flippedCards[1]].element.classList.remove('flipped');
                        flippedCards = [];
                    }, 1000);
                }
            }
        }
        
        // 开始计时
        function startTimer() {
            clearInterval(timer);
            seconds = 0;
            updateTimer();
            
            timer = setInterval(() => {
                seconds++;
                updateTimer();
            }, 1000);
        }
        
        // 更新计时器显示
        function updateTimer() {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // 结束游戏
        function endGame() {
            clearInterval(timer);
            
            // 播放胜利音效
            winSound.play();
            
            // 添加庆祝效果
            createConfetti();
            
            // 添加到排行榜
            addToLeaderboard();
            
            alert(`恭喜 ${currentPlayer} 完成游戏！\n用时: ${timerDisplay.textContent}\n尝试次数: ${attempts}`);
        }
        
        // 添加到排行榜
        function addToLeaderboard() {
            const now = new Date();
            const timestamp = now.toLocaleString();
            
            leaderboard.push({
                player: currentPlayer,
                time: seconds,
                timestamp: timestamp
            });
            
            // 按时间排序
            leaderboard.sort((a, b) => a.time - b.time);
            
            // 限制排行榜数量
            if (leaderboard.length > 20) {
                leaderboard.pop();
            }
            
            // 保存到本地存储
            localStorage.setItem('poemMemoryGameLeaderboard', JSON.stringify(leaderboard));
            
            // 更新排行榜显示
            renderLeaderboard();
        }
        
        // 渲染排行榜
        function renderLeaderboard() {
            leaderboardBody.innerHTML = '';
            
            leaderboard.forEach((entry, index) => {
                const minutes = Math.floor(entry.time / 60);
                const seconds = entry.time % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${entry.player}</td>
                    <td>${timeString}</td>
                    <td>${entry.timestamp}</td>
                `;
                leaderboardBody.appendChild(row);
            });
        }
        
        // 切换设置面板
        function toggleSettings() {
            settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
            leaderboardPanel.style.display = 'none';
            
            // 更新诗句输入框
            poemsInput.value = poems.join('\n');
        }
        
        // 切换排行榜面板
        function toggleLeaderboard() {
            leaderboardPanel.style.display = leaderboardPanel.style.display === 'none' ? 'block' : 'none';
            settingsPanel.style.display = 'none';
        }
        
        // 保存诗句
        function savePoems() {
            const poemLines = poemsInput.value.split('\n').map(line => line.trim()).filter(line => line);
            
            if (poemLines.length < 4) {
                alert('请至少输入4句诗（2对）！');
                return;
            }
            
            poems = poemLines;
            localStorage.setItem('poemMemoryGamePoems', JSON.stringify(poems));
            
            alert('诗句设置已保存！');
            renderPoemPreview();
            toggleSettings();
        }
        
        // 恢复默认诗句
        function restoreDefaultPoems() {
            if (confirm('确定要恢复默认诗句吗？当前诗句将被替换。')) {
                poems = [...defaultPoems];
                poemsInput.value = poems.join('\n');
                localStorage.setItem('poemMemoryGamePoems', JSON.stringify(poems));
                renderPoemPreview();
            }
        }
        
        // 导出排行榜
        function exportLeaderboard() {
            if (leaderboard.length === 0) {
                alert('排行榜为空，没有数据可导出！');
                return;
            }
            
            let csv = '排名,姓名,时间(秒),日期\n';
            
            leaderboard.forEach((entry, index) => {
                csv += `${index + 1},${entry.player},${entry.time},${entry.timestamp}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `诗句消消乐排行榜_${new Date().toLocaleDateString()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 创建彩色纸屑效果
        function createConfetti() {
            const colors = ['#ff9ff3', '#feca57', '#ff6b6b', '#48dbfb', '#1dd1a1', '#f368e0'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                
                document.body.appendChild(confetti);
                
                // 动画结束后移除
                setTimeout(() => {
                    confetti.remove();
                }, 2000);
            }
        }
        
        // 辅助函数：打乱数组
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // 初始化应用
        init();
    </script>
</body>
</html>